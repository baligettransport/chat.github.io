<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pesan Real-Time</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <style>
        :root { 
            --bg: #f0f2f5; 
            --sidebar: #111b21; 
            --sidebar-header: #202c33;
            --chat-bg: #e5ddd5; 
            --msg-sent: #d9fdd3; 
            --msg-received: #fff; 
            --green: #25d366; 
            --dark: #202c33; 
            --text-light: #8696a0;
            --text-lighter: #d1d7db;
        }
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        }
        body { 
            display: flex; 
            height: 100vh; 
            background-color: var(--bg); 
            overflow: hidden; 
        }
        .auth-container { 
            display: none; 
            justify-content: center; 
            align-items: center; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(135deg, #075e54, #128c7e); 
            color: white; 
        }
        .auth-card { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 40px; 
            border-radius: 15px; 
            backdrop-filter: blur(10px); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); 
            text-align: center; 
            width: 90%; 
            max-width: 400px; 
        }
        .auth-card h2 { margin-bottom: 10px; }
        .auth-card p { margin-bottom: 30px; opacity: 0.8; }
        .auth-card input { 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 20px; 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 50px; 
            background: rgba(255,255,255,0.1); 
            color: white; 
            font-size: 16px; 
            outline: none; 
        }
        .auth-card input::placeholder { color: rgba(255,255,255,0.7); }
        .auth-card button { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 50px; 
            background-color: var(--green); 
            color: white; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .app-container { 
            display: none; 
            flex: 1; 
            height: 100%; 
        }
        .sidebar { 
            width: 350px; 
            background-color: var(--sidebar); 
            display: flex; 
            flex-direction: column; 
            height: 100%;
        }
        .sidebar-header { 
            padding: 10px 16px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            color: var(--text-lighter);
            background-color: var(--sidebar-header);
        }
        .sidebar-header h1 { font-size: 20px; font-weight: 400; }
        .sidebar-header .icons { display: flex; gap: 25px; font-size: 20px; cursor: pointer; }
        .sidebar-header .icons i:hover { color: white; }
        
        /* --- Header Mode Seleksi --- */
        .selection-header {
            display: none;
            padding: 10px 16px;
            align-items: center;
            justify-content: space-between;
            background-color: var(--sidebar-header);
            color: white;
        }
        .selection-header .left-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .selection-header .count {
            font-size: 18px;
        }
        .selection-header .icons {
            display: flex;
            gap: 25px;
            font-size: 20px;
            cursor: pointer;
        }
        .selection-header .icons i:hover { color: var(--text-lighter); }

        .search-box { padding: 8px 16px; background-color: var(--sidebar); }
        .search-box input { 
            width: 100%; 
            padding: 8px 12px; 
            border-radius: 8px; 
            background-color: var(--sidebar-header); 
            border: none; 
            color: var(--text-lighter); 
            outline: none; 
            font-size: 14px;
        }
        .search-box input::placeholder { color: var(--text-light); }
        .chat-tabs { display: flex; background-color: var(--sidebar); padding: 0 16px; }
        .chat-tab { 
            flex: 1; 
            padding: 8px 0; 
            text-align: center; 
            color: var(--text-light); 
            cursor: pointer; 
            border-bottom: 3px solid transparent;
            font-size: 14px;
            font-weight: 500;
        }
        .chat-tab.active { color: var(--text-lighter); border-bottom: 3px solid var(--green); }
        .chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item { 
            display: flex; 
            align-items: center; 
            padding: 12px 16px; 
            cursor: pointer; 
            color: white; 
            transition: background-color 0.2s; 
            position: relative;
        }
        .chat-item:hover, .chat-item.active { background-color: #2a3942; }
        .chat-item.selected { background-color: #2a3942; }
        .chat-item img { width: 48px; height: 48px; border-radius: 50%; margin-right: 15px; }
        .chat-item-details { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .chat-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .chat-item-details h4 { font-size: 16px; font-weight: 500; color: #e9edef; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item-details p { font-size: 13px; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item-time { font-size: 12px; color: var(--text-light); }
        
        /* --- Checkbox untuk Seleksi --- */
        .chat-checkbox {
            position: absolute;
            left: 16px;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-light);
            border-radius: 50%;
            background-color: transparent;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chat-item.selected .chat-checkbox {
            display: flex;
            background-color: var(--green);
            border-color: var(--green);
        }
        .chat-checkbox i {
            color: white;
            font-size: 12px;
        }
        .selection-mode .chat-item img { margin-left: 28px; }


        .welcome-screen { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            height: 100%; 
            color: var(--text-light);
            background-color: #efeae2;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }
        .welcome-screen i { font-size: 280px; color: var(--green); margin-bottom: 20px; opacity: 0.15; position: absolute; }
        .welcome-content { text-align: center; z-index: 1; }
        .welcome-content h2 { font-size: 32px; font-weight: 300; color: #41525d; margin-bottom: 15px; }
        .welcome-content p { font-size: 14px; color: var(--text-light); max-width: 600px; line-height: 1.5; }
        .welcome-content .features { list-style: none; margin-top: 20px; }
        .welcome-content .features li { margin-bottom: 8px; }
        .welcome-content .encryption-note { position: absolute; bottom: 20px; font-size: 12px; color: var(--text-light); }
        .chat-window { 
            display: none; 
            flex-grow: 1; 
            flex-direction: column; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
        }
        .chat-header { 
            padding: 10px 16px; 
            background-color: #f0f2f5; 
            display: flex; 
            align-items: center; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .chat-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; }
        .chat-header .info { flex-grow: 1; }
        .chat-header .info h3 { font-size: 18px; }
        .chat-header .info p { font-size: 13px; color: #667781; }
        .chat-header .icons { display: flex; gap: 20px; font-size: 20px; color: #51585c; cursor: pointer; }
        .messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .message { display: flex; margin-bottom: 15px; max-width: 75%; }
        .message.sent { align-self: flex-end; flex-direction: column; align-items: flex-end; }
        .message.received { align-self: flex-start; flex-direction: column; align-items: flex-start; }
        .message-bubble { padding: 10px 15px; border-radius: 10px; line-height: 1.5; word-wrap: break-word; }
        .message.sent .message-bubble { background-color: var(--msg-sent); }
        .message.received .message-bubble { background-color: var(--msg-received); }
        .message-time { font-size: 11px; color: #999; margin-top: 4px; }
        .chat-input { 
            padding: 8px 15px; 
            background-color: #f0f2f5; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .chat-input i { 
            color: #51585c; 
            font-size: 24px; 
            cursor: pointer; 
        }
        .chat-input .input-icons {
            display: flex;
            gap: 20px;
        }
        .chat-input input { 
            flex-grow: 1; 
            border: none; 
            background-color: white; 
            padding: 10px 15px; 
            border-radius: 20px; 
            font-size: 15px; 
            outline: none; 
        }
        .chat-input button { 
            background-color: var(--green); 
            color: white; 
            border: none; 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            font-size: 18px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: background-color 0.2s;
        }
        .chat-input button:hover {
            background-color: #128c7e;
        }
        .message-media {
            max-width: 300px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
        }
        .message-media img, .message-media video {
            width: 100%;
            display: block;
        }
        .back-button {
            display: none;
            margin-right: 15px;
            cursor: pointer;
            color: #51585c;
            font-size: 20px;
        }
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; z-index: 2; }
            .chat-window { width: 100%; }
            .welcome-screen { display: none; }
            .back-button { display: flex; align-items: center; }
        }
        @media (min-width: 769px) {
            .back-button { display: none; }
        }
    </style>
</head>
<body>

    <!-- Layar Autentikasi -->
    <div class="auth-container" id="auth-container">
        <div class="auth-card">
            <i class="fab fa-whatsapp" style="font-size: 50px; margin-bottom: 20px;"></i>
            <h2>Masuk ke Chat</h2>
            <p>Masukkan nama Anda untuk memulai</p>
            <form id="auth-form">
                <input type="text" id="username" placeholder="Masukkan nama Anda" required>
                <button type="submit">Masuk</button>
            </form>
        </div>
    </div>

    <!-- Kontainer Aplikasi Utama -->
    <div class="app-container" id="app-container">
        <aside class="sidebar" id="sidebar">
            <!-- Header Normal -->
            <header class="sidebar-header" id="normal-header">
                <h1>Obrolan</h1>
                <div class="icons">
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </header>
            
            <!-- Header Mode Seleksi -->
            <header class="selection-header" id="selection-header">
                <div class="left-section">
                    <i class="fas fa-times" id="exit-selection-btn"></i>
                    <span class="count" id="selection-count">1</span>
                </div>
                <div class="icons">
                    <i class="fas fa-thumbtack" title="Sematkan"></i>
                    <i class="fas fa-trash" title="Hapus"></i>
                    <i class="fas fa-bell-slash" title="Nonaktifkan notifikasi"></i>
                    <i class="fas fa-ellipsis-v" title="Lainnya"></i>
                </div>
            </header>

            <div class="search-box">
                <input type="text" id="search-input" placeholder="Cari atau mulai obrolan baru">
            </div>
            <div class="chat-tabs">
                <div class="chat-tab active" data-tab="all">SEMUA</div>
                <div class="chat-tab" data-tab="unread">TIDAK DIBACA</div>
            </div>
            <div class="chat-list" id="chat-list">
                <!-- Daftar chat akan dimuat di sini oleh JavaScript -->
            </div>
        </aside>

        <!-- Layar Selamat Datang -->
        <div class="welcome-screen" id="welcome-screen">
            <i class="fab fa-whatsapp"></i>
            <div class="welcome-content">
                <h2>WhatsApp Web Clone</h2>
                <p>Unduh aplikasi untuk Windows agar Anda dapat tetap terhubung di mana pun Anda berada. Dengan WhatsApp di komputer, Anda dapat:</p>
                <ul class="features">
                    <li>• Mengirim pesan pribadi kepada teman dan grup</li>
                    <li>• Melihat foto, video, dan dokumen yang dibagikan</li>
                    <li>• Menerima notifikasi di desktop Anda</li>
                </ul>
            </div>
            <p class="encryption-note">Pesan pribadi Anda dijaga kerahasiaannya dengan enkripsi end-to-end</p>
        </div>

        <!-- Jendela Chat -->
        <main class="chat-window" id="chat-window">
            <header class="chat-header">
                <i class="fas fa-arrow-left back-button" id="back-button"></i>
                <img src="https://i.pravatar.cc/150?img=69" alt="Chat" id="chat-header-pic">
                <div class="info">
                    <h3 id="chat-name">Nama Chat</h3>
                    <p id="chat-status">Status</p>
                </div>
            </header>
            <div class="messages" id="messages"></div>
            <div class="chat-input">
                <i class="fas fa-smile"></i>
                <div class="input-icons">
                    <i class="fas fa-paperclip"></i>
                    <i class="fas fa-camera" id="camera-button"></i>
                </div>
                <input type="text" id="message-input" placeholder="Pesan">
                <button id="action-btn"><i class="fas fa-microphone"></i></button>
                <input type="file" id="media-input" accept="image/*,video/*" style="display: none;">
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCahZIFKFXMCokFNxCpFokNSVtKzN4llus", 
            authDomain: "cedar-setup-425414-d7.firebaseapp.com", 
            databaseURL: "https://cedar-setup-425414-d7-default-rtdb.firebaseio.com", 
            projectId: "cedar-setup-425414-d7", 
            storageBucket: "cedar-setup-425414-d7.firebasestorage.app", 
            messagingSenderId: "723545991983", 
            appId: "1:723545991983:web:379548d2b425a502a60fda", 
            measurementId: "G-FPL6PF3KWJ" 
        };
        firebase.initializeApp(firebaseConfig);

        // --- INISIALISASI LAYANAN FIREBASE ---
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // --- REFERENSI UI ---
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const usernameInput = document.getElementById('username');
        const appContainer = document.getElementById('app-container');
        const chatList = document.getElementById('chat-list');
        const searchInput = document.getElementById('search-input');
        const sidebar = document.getElementById('sidebar');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatWindow = document.getElementById('chat-window');
        const chatName = document.getElementById('chat-name');
        const chatStatus = document.getElementById('chat-status');
        const chatHeaderPic = document.getElementById('chat-header-pic');
        const backButton = document.getElementById('back-button');
        const cameraButton = document.getElementById('camera-button');
        const mediaInput = document.getElementById('media-input');
        const messageInput = document.getElementById('message-input');
        const actionBtn = document.getElementById('action-btn');
        const actionBtnIcon = actionBtn.querySelector('i');
        const paperclipButton = document.querySelector('.fa-paperclip');
        
        // --- UI MODE SELEKSI ---
        const normalHeader = document.getElementById('normal-header');
        const selectionHeader = document.getElementById('selection-header');
        const selectionCount = document.getElementById('selection-count');
        const exitSelectionBtn = document.getElementById('exit-selection-btn');
        
        let currentUser = null;
        let currentChatId = 'general';
        let messagesListener = null;

        // --- STATE MODE SELEKSI ---
        let isSelectionModeActive = false;
        let selectedChats = new Set();

        // --- AUTENTIKASI ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showApp();
                db.collection('users').doc(user.uid).set({
                    displayName: user.displayName || 'Anonymous',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } else {
                showAuthScreen();
            }
        });

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (username) {
                auth.signInAnonymously().then(result => {
                    return result.user.updateProfile({ displayName: username });
                }).catch(error => {
                    console.error("Login failed:", error);
                    alert("Gagal masuk. Silakan coba lagi.");
                });
            }
        });

        function showAuthScreen() {
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        function showApp() {
            authContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            initializeChatApp();
        }
        
        function initializeChatApp() {
            setupEventListeners();
            loadUsers();
            selectChat('general', 'Chat Umum', 'Semua orang', 'https://i.pravatar.cc/150?img=69');
        }
        
        function setupEventListeners() {
            // ... (event listener yang sudah ada, tidak berubah)
            const sendMessage = () => {
                const text = messageInput.value.trim();
                if (!text || !currentUser) return;
                
                const newMessage = { 
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    text: text, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                db.collection('chats').doc(currentChatId).collection('messages').add(newMessage);
                messageInput.value = '';
                actionBtnIcon.classList.remove('fa-paper-plane');
                actionBtnIcon.classList.add('fa-microphone');
            };

            actionBtn.addEventListener('click', () => {
                if (actionBtnIcon.classList.contains('fa-paper-plane')) {
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', () => {
                if (messageInput.value.trim() === '') {
                    actionBtnIcon.classList.remove('fa-paper-plane');
                    actionBtnIcon.classList.add('fa-microphone');
                } else {
                    actionBtnIcon.classList.remove('fa-microphone');
                    actionBtnIcon.classList.add('fa-paper-plane');
                }
            });

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && messageInput.value.trim() !== '') {
                    sendMessage();
                }
            });
            
            cameraButton.addEventListener('click', () => mediaInput.click());
            
            mediaInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || !currentUser) return;

                const filePath = `media/${currentChatId}/${currentUser.uid}_${Date.now()}`;
                const storageRef = storage.ref(filePath);
                const uploadTask = storageRef.put(file);

                actionBtnIcon.classList.remove('fa-paper-plane', 'fa-microphone');
                actionBtnIcon.classList.add('fa-spinner', 'fa-pulse');

                uploadTask.on('state_changed', 
                    () => {}, 
                    (error) => {
                        console.error("Upload failed:", error);
                        actionBtnIcon.classList.remove('fa-spinner', 'fa-pulse');
                        actionBtnIcon.classList.add('fa-microphone');
                    }, 
                    () => {
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            const mediaType = file.type.split('/')[0];
                            const newMessage = {
                                senderId: currentUser.uid,
                                senderName: currentUser.displayName,
                                mediaUrl: downloadURL,
                                mediaType: mediaType,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            db.collection('chats').doc(currentChatId).collection('messages').add(newMessage);
                            actionBtnIcon.classList.remove('fa-spinner', 'fa-pulse');
                            actionBtnIcon.classList.add('fa-microphone');
                        });
                    }
                );
                event.target.value = '';
            });

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filterChatItems(searchTerm);
            });

            backButton.addEventListener('click', () => {
                sidebar.style.display = 'flex';
                chatWindow.style.display = 'none';
            });

            // --- EVENT LISTENER MODE SELEKSI ---
            exitSelectionBtn.addEventListener('click', exitSelectionMode);

            selectionHeader.querySelectorAll('.icons i').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    e.stopPropagation(); // Mencegah event bubbling
                    const action = icon.title;
                    handleSelectionAction(action);
                });
            });
        }
        
        function loadUsers() {
            if (window.usersListener) window.usersListener();
            
            const generalChatItem = createChatItem('general', 'Chat Umum', 'Bergabunglah dengan semua orang', 'https://i.pravatar.cc/150?img=69');
            chatList.appendChild(generalChatItem);

            window.usersListener = db.collection('users').onSnapshot(snapshot => {
                const userItems = chatList.querySelectorAll('.chat-item[data-user-id]');
                userItems.forEach(item => item.remove());

                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const userId = doc.id;

                    if (userId !== currentUser.uid) {
                        const displayName = userData.displayName || 'Unknown User';
                        const avatarSeed = userId.length + userId.charCodeAt(0);
                        const avatarUrl = `https://i.pravatar.cc/150?img=${avatarSeed % 70}`;
                        const statusText = 'Klik untuk memulai obrolan';

                        const userItem = createChatItem(userId, displayName, statusText, avatarUrl, true);
                        chatList.appendChild(userItem);
                    }
                });
            });
        }
        
        function createChatItem(id, name, lastMessage, avatarUrl, isUser = false) {
            const chatItem = document.createElement('div');
            chatItem.classList.add('chat-item');
            chatItem.dataset.chatId = id;
            if(isUser) chatItem.dataset.userId = id;

            chatItem.innerHTML = `
                <div class="chat-checkbox"><i class="fas fa-check"></i></div>
                <img src="${avatarUrl}" alt="${name}">
                <div class="chat-item-details">
                    <div class="chat-item-header">
                        <h4>${name}</h4>
                        <span class="chat-item-time">now</span>
                    </div>
                    <p>${lastMessage}</p>
                </div>
            `;
            
            // --- LOGIKA LONG PRESS DAN SELEKSI ---
            let longPressTimer;
            
            const startPress = (e) => {
                if (isSelectionModeActive) {
                    e.preventDefault(); // Mencegah aksi default saat mode seleksi aktif
                    return;
                }
                longPressTimer = setTimeout(() => {
                    enterSelectionMode(id);
                }, 500); // 500ms untuk long press
            };

            const endPress = () => {
                clearTimeout(longPressTimer);
            };

            chatItem.addEventListener('mousedown', startPress);
            chatItem.addEventListener('mouseup', endPress);
            chatItem.addEventListener('mouseleave', endPress); // Batalkan jika mouse keluar area
            chatItem.addEventListener('touchstart', startPress);
            chatItem.addEventListener('touchend', endPress);

            chatItem.addEventListener('click', (e) => {
                if (isSelectionModeActive) {
                    e.stopPropagation(); // Mencegah membuka chat saat mode seleksi
                    toggleChatSelection(id);
                } else {
                    selectChat(id, name, 'Online', avatarUrl);
                }
            });
            
            return chatItem;
        }
        
        function enterSelectionMode(chatId) {
            isSelectionModeActive = true;
            selectedChats.add(chatId);
            sidebar.classList.add('selection-mode');
            normalHeader.style.display = 'none';
            selectionHeader.style.display = 'flex';
            updateSelectionUI();
        }

        function exitSelectionMode() {
            isSelectionModeActive = false;
            selectedChats.clear();
            sidebar.classList.remove('selection-mode');
            normalHeader.style.display = 'flex';
            selectionHeader.style.display = 'none';
            updateSelectionUI();
        }

        function toggleChatSelection(chatId) {
            if (selectedChats.has(chatId)) {
                selectedChats.delete(chatId);
            } else {
                selectedChats.add(chatId);
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedChats.size;
            selectionCount.textContent = count;

            document.querySelectorAll('.chat-item').forEach(item => {
                const id = item.dataset.chatId;
                if (selectedChats.has(id)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });

            // Jika tidak ada yang terpilih, keluar dari mode seleksi
            if (count === 0 && isSelectionModeActive) {
                exitSelectionMode();
            }
        }

        function handleSelectionAction(action) {
            console.log(`Aksi: ${action} pada ${selectedChats.size} chat.`);
            // TODO: Implementasikan logika untuk setiap aksi
            switch(action) {
                case 'Sematkan':
                    // Logika untuk menyematkan chat
                    break;
                case 'Hapus':
                    if (confirm(`Apakah Anda yakin ingin menghapus ${selectedChats.size} chat ini?`)) {
                        // Logika untuk menghapus chat dari Firestore
                        console.log('Menghapus chat...');
                    }
                    break;
                case 'Nonaktifkan notifikasi':
                    // Logika untuk menonaktifkan notifikasi
                    break;
                case 'Lainnya':
                    // Tampilkan menu lainnya
                    break;
            }
            // Keluar dari mode seleksi setelah aksi
            exitSelectionMode();
        }
        
        function selectChat(chatId, name, status, avatarUrl) {
            if (isSelectionModeActive) return; // Jangan lakukan apa-apa jika mode seleksi aktif
            
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if(activeItem) activeItem.classList.add('active');
            
            chatHeaderPic.src = avatarUrl;
            chatName.textContent = name;
            chatStatus.textContent = status;
            
            currentChatId = chatId;
            loadMessages(chatId);

            if (window.innerWidth <= 768) {
                sidebar.style.display = 'none';
                chatWindow.style.display = 'flex';
            } else {
                welcomeScreen.style.display = 'none';
                chatWindow.style.display = 'flex';
            }
        }
        
        function loadMessages(chatId) {
            const messagesEl = document.getElementById('messages');
            
            if (messagesListener) messagesListener();
            messagesEl.innerHTML = '';
            
            messagesListener = db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            renderMessage(change.doc.data());
                        }
                    });
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                });
        }
        
        function renderMessage(data) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            const isSent = data.senderId === currentUser.uid;
            
            messageEl.classList.add('message', isSent ? 'sent' : 'received');

            if (data.mediaUrl) {
                const mediaEl = document.createElement('div');
                mediaEl.classList.add('message-media');
                if (data.mediaType === 'image') {
                    mediaEl.innerHTML = `<img src="${data.mediaUrl}" alt="Image">`;
                } else if (data.mediaType === 'video') {
                    mediaEl.innerHTML = `<video src="${data.mediaUrl}" controls></video>`;
                }
                messageEl.appendChild(mediaEl);
            } else if (data.text) {
                const bubbleEl = document.createElement('div');
                bubbleEl.classList.add('message-bubble');
                bubbleEl.textContent = data.text;
                messageEl.appendChild(bubbleEl);
            }
            
            const timeEl = document.createElement('span');
            timeEl.classList.add('message-time');
            if(data.timestamp && data.timestamp.toDate) {
                timeEl.textContent = data.timestamp.toDate().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            }
            messageEl.appendChild(timeEl);
            
            messagesEl.appendChild(messageEl);
        }
        
        function filterChatItems(searchTerm) {
            const chatItems = document.querySelectorAll('.chat-item');
            chatItems.forEach(item => {
                const name = item.querySelector('h4').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    });
    </script>
</body>
</html>